<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Fuyao-Jiang"><meta name="description" content="区块链开发、golang、智能合约、共识算法、密码学、Bitcoin、Ethereum、Bitshare源码解析、超级账本"><link rel="alternative" href="/atom.xml" title="姜富耀 | BlockChain" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>区块链开发 Go语言：并发之管道 - 姜富耀 | BlockChain</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0;"><header class="head"><h1 class="head-title u-fl"><a href="/">姜富耀 | BlockChain</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">☯ DIR'/（目录）</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-01-30T10:13:25.000Z">一月 30, 2018</time><h1 class="post__title"><a href="/2018/01/30/区块链开发-Go语言：并发之管道/">区块链开发 Go语言：并发之管道</a></h1><div class="post__main echo"><blockquote>
<p><strong>管道</strong>(Channel)是Go语言中比较重要的部分，经常在Go中的并发中使用。  </p>
<p>管道是在多个线程之间传递数据和同步数据的重要手段。<br>对通道的操作本身是同步的。同一时刻仅有一个线程能向一个通道发送元素值。<br>同时只有一个进程能从管道接收元素值。  </p>
</blockquote>
<p>我们可以使用channel在多个goroutine之间传递消息。<br>channel是<strong>进程内</strong>的通讯方式，是不支持跨进程通信的，  </p>
<blockquote>
<p>管道是<strong>先进先出</strong></p>
</blockquote>
<h3 id="声明一个管道"><a href="#声明一个管道" class="headerlink" title="声明一个管道"></a>声明一个管道</h3><blockquote>
<p>声明一个能传递int 数据类型的管道：  </p>
</blockquote>
<p><code>var chanName chan int</code></p>
<blockquote>
<p>用make()方法创建一个能传递int类型的 管道：</p>
</blockquote>
<p><strong><code>a := make(chan int)</code></strong>  </p>
<blockquote>
<p>上面例子是：<strong>非缓冲 管道</strong>。  </p>
</blockquote>
<p><strong>非缓冲管道</strong>通俗讲：就像一个管子中：一次爬进去一个人，只有这个人出来才能爬进去第二个人。一个数据进去 还没没出来，另一个数据又要进去 会产生<strong>阻塞</strong>。  </p>
<p><img src="http://p37d7w3w4.bkt.clouddn.com/001%E9%9D%9E%E7%BC%93%E5%AD%98%E7%AE%A1%E9%81%93.png" alt="非缓存管道">  </p>
<blockquote>
<p>那什么是 <strong>缓冲 管道</strong> 呢？  </p>
</blockquote>
<p><strong>缓冲管道</strong> 通俗讲：创建时可以设置缓冲容量大小，不会阻塞，除非缓冲容量满了。  </p>
<p><img src="http://p37d7w3w4.bkt.clouddn.com/002%E7%BC%93%E5%86%B2%E7%AE%A1%E9%81%93.png" alt="缓冲管道"></p>
<blockquote>
<p>创建<strong>缓冲管道</strong> 格式。  </p>
</blockquote>
<p><img src="http://p37d7w3w4.bkt.clouddn.com/003%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%BC%93%E5%86%B2%E9%80%9A%E9%81%93.png" alt="创建缓冲管道">  </p>
<p><code>c := make(chan int, 4)</code>  </p>
<blockquote>
<p>给<strong>缓冲管道</strong>传值    </p>
</blockquote>
<p><img src="http://p37d7w3w4.bkt.clouddn.com/004%E7%BB%99%E7%BC%93%E5%86%B2%E7%AE%A1%E9%81%93%E4%BC%A0%E5%80%BC.png" alt="给缓冲管道传值">  </p>
<p>给缓冲管道传值格式： <code>c &lt;- 250</code>  </p>
<blockquote>
<p><strong>非缓冲管道</strong> 和 <strong>缓冲管道</strong> 的区别！  </p>
</blockquote>
<p><strong>非缓冲管道</strong> 就如同：一个送信人去你家门口送信 ，<br>你不在家 他不走(<strong>阻塞</strong>)，你一定要接下信，他才会走。<br><strong>无缓冲</strong>保证信能到你手上。 </p>
<p><strong>缓冲管道</strong>的 就是一个送信人去你家仍到你家的信箱 转身就走 ，<br>除非你的信箱满了 他必须等信箱空下来(<strong>阻塞</strong>)。<br><strong>缓冲管道</strong> 保证 信能进你家的邮箱。  </p>
<blockquote>
<p><strong>非缓冲管道</strong> 的<strong>容量</strong>和<strong>长度</strong>都为<strong>0</strong>  </p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">	fmt.Println(<span class="string">"长度："</span>, <span class="built_in">len</span>(c)) <span class="comment">//打印管道c的 长度</span></span><br><span class="line">	fmt.Println(<span class="string">"容量："</span>, <span class="built_in">cap</span>(c)) <span class="comment">//打印管道c的 容量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">终端运行，看结果：</span><br><span class="line">threebody:~/Desktop/golang/0130$ go run test.go </span><br><span class="line">长度：0</span><br><span class="line">容量：0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从管道中 <strong>取值</strong> 的方法：  </p>
</blockquote>
<p><code>fmt.Println(&lt;-c)</code>//从管道中取值，取出c,并打印。</p>
<p><code>&lt;-c</code> //从管道中取值，不输出结果。(对于非缓存管道，必须把值取出来，才能放别的)  </p>
<p><code>a := &lt;-c</code>//将管道中取出的值，赋值给 a  </p>
<p><code>k, ok := &lt;-c</code> //从管道里面取值赋值给k，如果赋值成功，ok 为 true，如果赋值不成功，ok 为 flase    </p>
<blockquote>
<p>综合案例：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个管道</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">	<span class="comment">// 查看写入管道中数据的数量</span></span><br><span class="line">	fmt.Println(<span class="built_in">len</span>(c))</span><br><span class="line">	<span class="comment">// 查看管道的缓冲容量</span></span><br><span class="line">	fmt.Println(<span class="built_in">cap</span>(c))</span><br><span class="line"></span><br><span class="line">	c &lt;- <span class="number">10</span> <span class="comment">//写入数据，这条管道只能写入int类型</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="built_in">len</span>(c))</span><br><span class="line">	fmt.Println(<span class="built_in">cap</span>(c))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;-c //从管道里面取值</span></span><br><span class="line">	<span class="comment">// fmt.Println("从管道里面取值：", &lt;-c)</span></span><br><span class="line">	a := &lt;-c <span class="comment">//将管道里面取出来的值赋给a</span></span><br><span class="line">	fmt.Println(<span class="string">"a = "</span>, a)</span><br><span class="line">	c &lt;- <span class="number">20</span></span><br><span class="line">	k, ok := &lt;-c <span class="comment">//从管理里面取值赋给k，如果赋值成功，ok为true</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(k, <span class="string">"  "</span>, ok)</span><br><span class="line">	fmt.Println(<span class="built_in">len</span>(c))</span><br><span class="line">	fmt.Println(<span class="built_in">cap</span>(c))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">运行，看结果：</span><br><span class="line">threebody:~/Desktop/golang/0130$ go run test2.go</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">a =  10</span><br><span class="line">20    true</span><br></pre></td></tr></table></figure>
<blockquote>
<p>再来看一个有问题，需要注意的案例：  </p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个管道</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从管道里面取值赋给a</span></span><br><span class="line">	a, ok := &lt;-c <span class="comment">//管道内没有数据，无法取出，一直等待，出现死锁。</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(a, <span class="string">"  "</span>, ok)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">运行，看结果：**报错**!!！</span><br><span class="line">threebody:~/BlockChain-learn/$ go run 002_管道.go </span><br><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine 1 [chan receive]:</span><br><span class="line">main.main()</span><br><span class="line">	/BlockChain-learn/002_管道.go:11 +0x55</span><br><span class="line">exit status 2</span><br><span class="line">原因：//a, ok := &lt;-c //管道内没有数据，无法取出，一直等待，出现死锁。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面例子，改错：  </p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个管道</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">  </span><br><span class="line">	c &lt;- <span class="number">10</span> <span class="comment">//给管道传值</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从管道里面取值赋给a</span></span><br><span class="line">	a, ok := &lt;-c <span class="comment">//同步</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(a, <span class="string">"  "</span>, ok)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行，看结果：</span><br><span class="line">threebody:BlockChain-learn/$ go run 003_管道.go </span><br><span class="line">10    true</span><br></pre></td></tr></table></figure>
<blockquote>
<p>把管道取值放到 子线程中，让主线程休眠一会，有足够时间给子线程：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个管道</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// 从管道里面取值赋给a</span></span><br><span class="line">		a, ok := &lt;-c <span class="comment">//同步</span></span><br><span class="line">		fmt.Println(a, <span class="string">"  "</span>, ok)</span><br><span class="line">	&#125;()</span><br><span class="line">  </span><br><span class="line">	c &lt;- <span class="number">10</span></span><br><span class="line">	<span class="comment">// 休眠一会儿是为了等待子线程处理任务</span></span><br><span class="line">	time.Sleep(time.Second)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">运行，看结果：</span><br><span class="line">threebody:/BlockChain-learn/0130管道$ go run 005_demo.go </span><br><span class="line">10    true</span><br></pre></td></tr></table></figure>
<blockquote>
<p>用队列方式，休眠，让子线程从管道中取值：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sy sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个管道</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">	sy.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//子线程</span></span><br><span class="line">		<span class="comment">// 从管道里面取值赋给a</span></span><br><span class="line">		a, ok := &lt;-c <span class="comment">//同步</span></span><br><span class="line">		fmt.Println(a, <span class="string">"  "</span>, ok)</span><br><span class="line">		sy.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	c &lt;- <span class="number">10</span></span><br><span class="line">	sy.Wait()</span><br><span class="line">&#125;<span class="comment">//运行结果同上，只是把休眠改成队列。</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>对于<strong>非缓冲管道</strong>，写入管道，和读取管道都在<strong>子线程</strong>的案例：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup <span class="comment">//队列</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 先创建一个非缓冲管道</span></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">//子线程</span></span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">			c &lt;- i <span class="comment">//写入数据</span></span><br><span class="line">			fmt.Println(<span class="string">"写入数据"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">			a := &lt;-c</span><br><span class="line">			fmt.Println(a) <span class="comment">//读取数据</span></span><br><span class="line">			fmt.Println(<span class="string">"读取数据"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">运行，看结果：思考：  </span><br><span class="line">（“读物数据” 、 “写入数据” 和 数字出现顺序，上下文切换，时间片轮转的原因。)  </span><br><span class="line">threebody:/BlockChain-learn/$ go run 009_demo.go </span><br><span class="line">写入数据</span><br><span class="line">0</span><br><span class="line">读取数据</span><br><span class="line">1</span><br><span class="line">读取数据</span><br><span class="line">写入数据</span><br><span class="line">写入数据</span><br><span class="line">2</span><br><span class="line">读取数据</span><br><span class="line">3</span><br><span class="line">读取数据</span><br><span class="line">写入数据</span><br><span class="line">写入数据</span><br><span class="line">4</span><br><span class="line">读取数据</span><br><span class="line">5</span><br><span class="line">读取数据</span><br><span class="line">写入数据</span><br><span class="line">写入数据</span><br><span class="line">6</span><br><span class="line">读取数据</span><br><span class="line">7</span><br><span class="line">读取数据</span><br><span class="line">写入数据</span><br><span class="line">写入数据</span><br><span class="line">8</span><br><span class="line">读取数据</span><br><span class="line">9</span><br><span class="line">读取数据</span><br><span class="line">写入数据</span><br></pre></td></tr></table></figure>
<blockquote>
<p>再看一个 管道 与 并发 的 实例：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">			fmt.Println(<span class="string">"------"</span>)</span><br><span class="line">			c &lt;- i</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">close</span>(c)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> n := <span class="keyword">range</span> c &#123;</span><br><span class="line">		fmt.Println(<span class="string">"++++++++++"</span>)</span><br><span class="line">		fmt.Println(n)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>for i := range c</code>能够不断的读取 管道 里面的数据<br>直到，通过<code>close()</code>关闭管道，无法再发送任何数据。<br>可以通过语法<code>v, ok := &lt;-ch</code>测试channel是否被关闭。<br>如果ok返回false，那么说明channel已经没有任何数据并且已经被关闭。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">运行，看结果：  </span><br><span class="line">threebody:/BlockChain-learn、$ go run 011-demo.go </span><br><span class="line">------</span><br><span class="line">------</span><br><span class="line">++++++++++</span><br><span class="line">0</span><br><span class="line">++++++++++</span><br><span class="line">1</span><br><span class="line">------</span><br><span class="line">------</span><br><span class="line">++++++++++</span><br><span class="line">2</span><br><span class="line">++++++++++</span><br><span class="line">3</span><br><span class="line">------</span><br><span class="line">------</span><br><span class="line">++++++++++</span><br><span class="line">4</span><br><span class="line">++++++++++</span><br><span class="line">5</span><br><span class="line">------</span><br><span class="line">------</span><br><span class="line">++++++++++</span><br><span class="line">6</span><br><span class="line">++++++++++</span><br><span class="line">7</span><br><span class="line">------</span><br><span class="line">------</span><br><span class="line">++++++++++</span><br><span class="line">8</span><br><span class="line">++++++++++</span><br><span class="line">9</span><br></pre></td></tr></table></figure>
<blockquote>
<p>利用队列，多个子线程执行完毕后关闭再 管道 的案例：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>) <span class="comment">//创建通道</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup <span class="comment">//队列</span></span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"111111111"</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">			c &lt;- i</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"22222222"</span>)</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">10</span>; i &lt; <span class="number">20</span>; i++ &#123;</span><br><span class="line">			c &lt;- i</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"33333333"</span>)</span><br><span class="line">		wg.Wait()</span><br><span class="line">		<span class="built_in">close</span>(c)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> n := <span class="keyword">range</span> c &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// &lt;-c  有返回值</span></span><br><span class="line">		fmt.Println(n)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">运行，看结果：</span><br><span class="line">threebody:/BlockChain-learn/0130管道$ go run 013-demo.go </span><br><span class="line">33333333</span><br><span class="line">111111111</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">22222222</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td></tr></table></figure>
<blockquote>
<p>多个子线程执行结束后，关闭通道的案例：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">   c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">   done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">         c &lt;- i</span><br><span class="line">      &#125;</span><br><span class="line">      done &lt;- <span class="literal">true</span></span><br><span class="line">   &#125;()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">         c &lt;- i</span><br><span class="line">      &#125;</span><br><span class="line">      done &lt;- <span class="literal">true</span></span><br><span class="line">   &#125;()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      &lt;-done <span class="comment">//不放到子线程 函数内，会死锁！</span></span><br><span class="line">      &lt;-done</span><br><span class="line">      <span class="built_in">close</span>(c)</span><br><span class="line">   &#125;()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> n := <span class="keyword">range</span> c &#123;</span><br><span class="line">      fmt.Println(n)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">运行，看结果：</span><br><span class="line">threebody:/BlockChain-learn/0130管道$ go run 016_demo.go </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p><strong><em>日后随着 学习打怪的不断深入，会解锁其他的高级教程。</em></strong>  </p>
<h3 id="期待-吗？-那就关注下面-公众号-随时锁定区块链开发学习教程进度-："><a href="#期待-吗？-那就关注下面-公众号-随时锁定区块链开发学习教程进度-：" class="headerlink" title="期待 吗？ 那就关注下面 公众号 随时锁定区块链开发学习教程进度 ：)"></a><strong><em>期待 吗？ 那就关注下面 公众号 随时锁定区块链开发学习教程进度 ：)</em></strong></h3></blockquote>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/Golang/">Golang</a></li></ul></footer></article><section class="reward"><a class="btn-reward" href="#">关注公众号</a><div class="reward-wrapper clearfix"><img src="/img/wechat.jpg" title="公众号：区块链开发技术共享"><img src="/img/lianhu.jpg" title="公众号：区块链部落"></div></section><div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC8zMzU4MC8xMDEzNQ=="><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2018 Fuyao-Jiang</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>